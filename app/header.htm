  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script type="text/javascript">
    var snapshots = [];
    var db = null;
    var path = null;
    var selected_db_index = 0;

    $(document).ready(function() {
      console.log("ready");

      /* Show main_sidebar only if duc.cgi is in the URL */
      console.log("URL:", location.href);
      if ((location.href.indexOf("duc.cgi") !== -1) || (location.href.indexOf("/?db") !== -1) || (location.href.indexOf("error.cgi") !== -1) ) {
        document.getElementById("main_sidebar").style.display = "inline";
      }

      /* Fetch list of databases and fill them into the list */
      $.ajax("get-databases.cgi", {
        success: function (data) {
          // Success callback function
          console.log(data)
          
          /* Delete the last one entry since it is always "0" */
          data.databases.pop()
    
          /* Extract the parameters from the URL */
          db = (new URL(location.href)).searchParams.get('db')
          if (db == null) {
            console.log("No 'db' parameter in URL, selecting latest DB");
            db = data.databases[data.databases.length - 1]["db"]
          }
          console.log("Selected DB: " + db)

          path = (new URL(location.href)).searchParams.get('path')
          if (path == null) {
            console.log("No 'path' parameter in URL, selecting '/scan'");
            path = "/scan"
          }
          //path = path.split("?")[0]
          console.log("Path: " + path)

          /* Iterate through the list */
          for(let i = 0; i < data.databases.length; i++) {
            let selected = false;
            db_tmp = data.databases[i]["name"]
            if (db_tmp == db) { // Selected snapshot
              selected = true;
              selected_db_index = i;
            }

            db_tmp = db_tmp.replace("/database/duc_", "").replace(".db", "").replace("_", " ").split(" ")
            db_name = db_tmp[0] + "_" + db_tmp[1].replaceAll(":", "-")
            title = db_tmp[0] + " " + db_tmp[1].split("_")[0].replaceAll("-", ":")
            snapshots.push({"db": db_name, "title": title, "selected": selected, "size": data.databases[i]["size"]});
          }

          console.log("Snapshots:", snapshots)
          console.log("selected index: " + selected_db_index);

          if (db != null) {
            /* Format the list */
            list = document.getElementById("databases_list")
            console.log(snapshots.length + " snapshots available");
            for(let i = 0; i < snapshots.length; i++) {
              let li = document.createElement('li');
              
              let entry_class = "not_selected_snapshot"
              let a_class = ""
              if (snapshots[i].selected == true) { // Selected snapshot
                  entry_class = "selected_snapshot"
                  a_class = "selected_snapshot_link"
              }                  
              
              li.innerHTML = "<span class=" + entry_class + "><a class=\"snapshot_link " + a_class + "\" style=\"display: inline-block; width: 240px;\" href=" + 
                url_from_snapshot_index(i) + ">" + snapshots[i].title + " (" + Math.round(snapshots[i].size * 10 / 1024 / 1024 / 1024) / 10 + " GB)</a></span>"
              li.className = "snapshot"                        
              list.appendChild(li);
            }

            /* Convert path to URL */
            p = document.getElementById("path");
            p.innerHTML = url_from_snapshot_index(selected_db_index); // Select latest snapshot

            folders = path.split("/")
            f = "";
            txt = "<span class=\"not_selected_snapshot\"><a class=\"snapshot_link\" href='" + url_from_path(db, "/scan") + "'>/</a></span> &gt; ";
            for (let i = 2; i < folders.length; i++) {
              f += folders[i] + "/";
              txt += "<span class=\"not_selected_snapshot\"><a class=\"snapshot_link\" href='" + url_from_path(db, "/scan/" + f.slice(0, -1)) + "'>" + folders[i] + "</a></span> &gt; ";
            }
            p.innerHTML = txt;
          }
        },
        error: function (xhr, ajaxOptions, thrownError) {
          // Error callback
          console.log("Error, failed to fetch get-databases.cgi: " + xhr.status + ", " + thrownError + "!");
          document.getElementById("databases").innerHTML = "Failed to read the list of snapshots!<br>Error: " + xhr.status + ", " + thrownError + "!"
        },
      });

      document.addEventListener('keypress', function(event) {
        var key = event.key.toLowerCase();
        console.log("Key pressed: " + key);

        if (key == "p") {
          /* Get snapshot before the selected one */
          if (selected_db_index > 0) {
            index = selected_db_index - 1;
            window.location.href = url_from_snapshot_index(index)
          }

        } else if (key == "n") {
          /* Get snapshot after the selected one */
          if (selected_db_index < snapshots.length - 1) {
            index = selected_db_index + 1;
            window.location.href = url_from_snapshot_index(index)
          }
        }
      })
    })


    function url_from_snapshot_index(index) {
      if (index < 0 || index >= snapshots.length) {
        console.log("Index out of bounds: " + index);
        index = snapshots.length - 1;
      }
      return "duc.cgi?cmd=index&db=/database/duc_" + snapshots[index].db + ".db&path=" + path;
    }


    function url_from_path(db, path) {
      return "duc.cgi?cmd=index&db=/database/duc_" + db + ".db&path=" + path;
    }
  </script>


  <div id=sidebar>
      <div style="padding: 0;  margin-bottom: 20px;">
          <div style="padding: 0;"><a href="/"><img src=logo.png width=70px style="float: left; padding-left: 0"></a></div>
          <div style="float: none; margin-left: 70px;"><a href="/" style="text-decoration: none"><h1>Storage Analyzer</h1></a></div>
      </div>

      <ul id="navigation_list">
        <li class="nav-li"><span class="not_selected_snapshot"><a class="snapshot_link " href="duc.cgi">Main</a></span></li>
        <li class="nav-li"><span class="not_selected_snapshot"><a class="snapshot_link " href="manual_scan.cgi">Start Scan</a></span></li>
        <li class="nav-li"><span class="not_selected_snapshot"><a class="snapshot_link " href="show-log.cgi">Log</a></span></li>
        <li class="nav-li"><span class="not_selected_snapshot"><a class="snapshot_link " href="show-help.cgi">Help</a></span></li>
      </ul>

      <div id="main_sidebar">
        <h3 style="margin-top: 5px; margin-bottom: 0; margin-left: 10px;">Keyboard shortcuts</h3>
        <p style="margin-top: 5px; margin-bottom: 0; margin-left: 10px;"><strong>n</strong>: next snapshot<br><strong>p</strong>: previous snapshot</p>

        <h2 style="margin-top: 10px; margin-bottom: 0; margin-left: 10px;">Snapshots</h2>
        <div id=databases><ul id="databases_list" style="margin:0"></ul></div>
      </div>
  </div>
  <div id=content2 >
    <div id=content_header_div style="width: 80%"><h2 id=content_header>Snapshot</h2></div>
    <div id=content style="float: left;">
  </div>
