<script src="jquery.min.js"></script>
<link rel="stylesheet" href="jquery.firework.css">
<script src="jquery.firework.js"></script>
<script>
  var snapshots = [];
  var db = null;
  var path = null;
  var selectedIndex = 0;

  function formatSize(bytes) {
    if (bytes > 1024 * 1024 * 1024) {
      return (Math.round(bytes * 10 / 1024 / 1024 / 1024) / 10) + ' GB';
    } else if (bytes > 1024 * 1024) {
      return (Math.round(bytes * 10 / 1024 / 1024) / 10) + ' MB';
    } else if (bytes > 1024) {
      return (Math.round(bytes * 10 / 1024) / 10) + ' KB';
    } else if (bytes > 0) {
      return bytes + ' B';
    }
    return '';
  }

  function urlFromIndex(index) {
    if (index < 0 || index >= snapshots.length) {
      firework.launch('Invalid snapshot index', 'danger', 2000);
      index = snapshots.length - 1;
    }
    return 'duc.cgi?cmd=index&db=/snapshots/duc_' + snapshots[index].db + '.db&path=' + path;
  }

  function urlFromPath(db, p) {
    console.log(db);
    return 'duc.cgi?cmd=index&db=' + db + '&path=' + p;
  }

  function parseDbName(name) {
    var parts = name.replace('/snapshots/duc_', '').replace('.db', '').replace('_', ' ').split(' ');
    return {
      db: parts[0] + '_' + parts[1].replaceAll(':', '-'),
      title: parts[0] + ' ' + parts[1].split('_')[0].replaceAll('-', ':')
    };
  }

  function renderSnapshots() {
    var list = $('#snapshots_list');
    list.empty();

    snapshots.forEach(function(snap, i) {
      var cls = snap.selected ? 'selected_snapshot' : 'not_selected_snapshot';
      var linkCls = snap.selected ? 'snapshot_link selected_snapshot_link' : 'snapshot_link';
      var sizeText = snap.size > 0 ? ' (' + formatSize(snap.size) + ')' : '';
      
      var li = $('<li class="snapshot"></li>');
      li.html('<span class="' + cls + '"><a class="' + linkCls + '" href="' + urlFromIndex(i) + '">' + 
              snap.title + sizeText + '</a></span>');
      list.append(li);
    });
  }

  function renderBreadcrumb() {
    var folders = path.split('/');
    var crumbs = '<span class="not_selected_snapshot"><a class="snapshot_link" href="' + 
                 urlFromPath(db, '/scan') + '">/</a></span>';
    var f = '';
    
    for (var i = 2; i < folders.length; i++) {
      f += folders[i] + '/';
      crumbs += ' <span class="breadcrumb-sep">â€º</span> <span class="not_selected_snapshot"><a class="snapshot_link" href="' + 
                urlFromPath(db, '/scan/' + f.slice(0, -1)) + '">' + folders[i] + '</a></span>';
    }
    
    $('#path').html(crumbs);
  }

  $(document).ready(function() {
    var url = new URL(location.href);
    var showSidebar = url.href.indexOf('duc.cgi') !== -1 || 
                      url.href.indexOf('/?db') !== -1 || 
                      url.href.indexOf('error.cgi') !== -1;

    if (showSidebar) {
      $('#main_sidebar').show();
    }

    $.ajax('get-snapshots.cgi', {
      success: function(data) {
        data.snapshots.pop();

        if (data.snapshots.length === 0) {
          snapshots = [];
          db = null;
          path = '/scan';
          $('#snapshots_list').html('<li class="snapshot"><span class="not_selected_snapshot">No snapshots yet</span></li>');
          $('#path').html('');
          return;
        }
        
        db = url.searchParams.get('db');
        if (!db && data.snapshots.length > 0) {
          db = data.snapshots[data.snapshots.length - 1]['db'];
        }

        path = url.searchParams.get('path') || '/scan';

        data.snapshots.forEach(function(item, i) {
          var parsed = parseDbName(item.name);
          var isSelected = item.name === db;
          if (isSelected) selectedIndex = i;
          
          snapshots.push({
            db: parsed.db,
            title: parsed.title,
            selected: isSelected,
            size: item.size
          });
        });

        if (db) {
          renderSnapshots();
          renderBreadcrumb();
        }
      },
      error: function(xhr, status, error) {
        firework.launch('Failed to load snapshots: ' + error, 'danger', 5000);
        $('#snapshots').html('<p class="error">Failed to load snapshots</p>');
      }
    });

    $(document).on('keypress', function(e) {
      var key = e.key.toLowerCase();

      if (snapshots.length === 0) {
        if (key === 'n' || key === 'p') {
          firework.launch('No snapshots available', 'warning', 2000);
        }
        return;
      }
      
      if (key === 'p' && selectedIndex > 0) {
        window.location.href = urlFromIndex(selectedIndex - 1);
      } else if (key === 'p') {
        firework.launch('Already at oldest snapshot', 'success', 1500);
      } else if (key === 'n' && selectedIndex < snapshots.length - 1) {
        window.location.href = urlFromIndex(selectedIndex + 1);
      } else if (key === 'n') {
        firework.launch('Already at latest snapshot', 'success', 1500);
      }
    });
  });
</script>

<div id="sidebar">
  <div class="logo-section">
    <a href="/"><img src="logo.png" alt="Logo" class="logo"></a>
    <a href="/" class="site-title"><h1>Storage Analyzer</h1></a>
  </div>

  <nav>
    <ul id="navigation_list">
      <li class="nav-li"><span class="not_selected_snapshot"><a class="snapshot_link" href="duc.cgi">Main</a></span></li>
      <li class="nav-li"><span class="not_selected_snapshot"><a class="snapshot_link" href="manage-snapshots.cgi">Manage</a></span></li>
      <li class="nav-li"><span class="not_selected_snapshot"><a class="snapshot_link" href="show-log.cgi">Log</a></span></li>
      <li class="nav-li"><span class="not_selected_snapshot"><a class="snapshot_link" href="show-help.cgi">Help</a></span></li>
    </ul>
  </nav>

  <div id="main_sidebar">
    <div class="keyboard-shortcuts">
      <h3>Keyboard shortcuts</h3>
      <p><strong>n</strong>: next snapshot<br><strong>p</strong>: previous snapshot</p>
    </div>

    <h3>Snapshots</h3>
    <div id="snapshots">
      <ul id="snapshots_list"></ul>
    </div>
  </div>
</div>

<div id="content2">
  <div id="content_header_div">
    <h2 id="content_header">Snapshot</h2>
  </div>
  <div id="content">
