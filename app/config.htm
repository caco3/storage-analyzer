  <!-- Exclude Patterns Section -->
  <div class="actions-section">
    <h1>Exclude Patterns</h1>
    <div class="config-controls-small">
      <input id="exclude-input" type="text" class="config-input" placeholder="proc sys dev run tmp">
      <button class="btn btn-primary" onclick="confirmSaveExclude()">Save Exclude</button>
    </div>
    <div class="config-help-top">
      Space- or comma-separated patterns.
    </div>
  </div>
  
  <hr class="section-separator">
  
  <!-- Schedule Section -->
  <div class="actions-section">
    <h1>Scan Schedule</h1>
    <div id="schedule-unsupported" class="config-warning">
      Current schedule is not in a supported format. Choose a new schedule below to overwrite it.
    </div>
    <div class="config-grid">
      <label for="schedule-mode" class="config-label">Frequency</label>
      <select id="schedule-mode" class="config-input-small">
        <option value="hourly">Hourly</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>

      <label for="schedule-minute" class="config-label">Minute</label>
      <input id="schedule-minute" type="number" min="0" max="59" value="0" class="config-input-small">

      <label for="schedule-hour" class="config-label">Hour</label>
      <input id="schedule-hour" type="number" min="0" max="23" value="0" class="config-input-small">

      <label for="schedule-dow" class="config-label">Day of week</label>
      <select id="schedule-dow" class="config-input-small">
        <option value="0">Sunday</option>
        <option value="1">Monday</option>
        <option value="2">Tuesday</option>
        <option value="3">Wednesday</option>
        <option value="4">Thursday</option>
        <option value="5">Friday</option>
        <option value="6">Saturday</option>
      </select>

      <label for="schedule-dom" class="config-label">Day of month</label>
      <input id="schedule-dom" type="number" min="1" max="31" value="1" class="config-input-small">
    </div>

    <div class="config-controls">
    <span class="config-summary"></span>
    <p><br></p>
    <button class="btn btn-primary config-button-right" onclick="confirmSaveSchedule()" title="Current schedule: 0 2 * * * *">Save Schedule</button>
  </div>
  
  <!-- Status Display -->
  <div id="status-message"></div>


<!-- Custom Modal Dialog -->
<div id="modal-overlay" class="modal-overlay">
  <div class="modal-dialog">
    <div class="modal-header">
      <h3 id="modal-title">Confirm</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p id="modal-message"></p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="modal-confirm-btn" onclick="modalConfirm()">Confirm</button>
    </div>
  </div>
</div>

<script>
  var selectedScanPaths = [];
  var availableScanFolders = [];
  var folderDialogExplicit = new Set();
  var folderFilter = '';
  var pendingAction = null;
  var pendingData = null;

  // Load configuration on page load
  $(document).ready(function() {
    loadExclude();
    loadSchedule();
    bindScheduleUI();
  });

  function showStatus(message, type) {
    var statusClass = 'actions-section';
    if (type === 'success') {
      statusClass = 'actions-section';
      $('#status-message').html('<div class="' + statusClass + ' status-success">' + message + '</div>');
    } else if (type === 'error') {
      statusClass = 'actions-section';
      $('#status-message').html('<div class="' + statusClass + ' status-error">' + message + '</div>');
    } else if (type === 'warning') {
      statusClass = 'actions-section';
      $('#status-message').html('<div class="' + statusClass + ' status-warning">' + message + '</div>');
    }
    setTimeout(function() {
      $('#status-message').html('');
    }, 5000);
  }

  
            
  // Exclude Patterns Functions
  function loadExclude() {
    $.ajax({
      url: "get-exclude.cgi",
      method: "GET",
      success: function(resp) {
        if (resp && resp.success) {
          $('#exclude-input').val(resp.exclude || '');
        } else {
          firework.launch('Failed to load exclude patterns', 'danger', 3000);
        }
      },
      error: function(xhr, status, error) {
        firework.launch('Failed to load exclude patterns: ' + error, 'danger', 3000);
      }
    });
  }

  function confirmSaveExclude() {
    var exclude = ($('#exclude-input').val() || '').trim();
    showModal(
      'Update Exclude Patterns',
      'Save exclude patterns?<br><br><strong>' + exclude + '</strong><br><br>This affects scheduled and manual scans.',
      'primary',
      saveExclude,
      exclude
    );
  }

  function saveExclude(exclude) {
    $.ajax({
      url: "set-exclude.cgi",
      method: "POST",
      data: { exclude: exclude },
      success: function(resp) {
        if (resp && resp.success) {
          firework.launch('Exclude patterns updated', 'success', 3000);
          $('#exclude-input').val(resp.exclude || exclude);
        } else {
          firework.launch('Failed to update exclude patterns: ' + (resp && resp.error ? resp.error : 'unknown error'), 'danger', 3000);
        }
      },
      error: function(xhr, status, error) {
        firework.launch('Failed to update exclude patterns: ' + error, 'danger', 3000);
      }
    });
  }

  // Schedule Functions
  function loadSchedule() {
    $.ajax({
      url: "get-schedule.cgi",
      method: "GET",
      success: function(resp) {
        if (resp && resp.success) {
          if (resp.supported) {
            $('#schedule-unsupported').hide();
            $('#schedule-mode').val(resp.mode);
            $('#schedule-minute').val(resp.minute);
            $('#schedule-hour').val(resp.hour);
            $('#schedule-dow').val(resp.dow);
            $('#schedule-dom').val(resp.dom);
          } else {
            $('#schedule-unsupported').show();
          }
          updateScheduleFieldsVisibility();
          updateSchedulePreview();
        } else {
          firework.launch('Failed to load schedule', 'danger', 3000);
        }
      },
      error: function(xhr, status, error) {
        firework.launch('Failed to load schedule: ' + error, 'danger', 3000);
      }
    });
  }

  function bindScheduleUI() {
    $('#schedule-mode').on('change', function() {
      updateScheduleFieldsVisibility();
      updateSchedulePreview();
    });
    $('#schedule-minute, #schedule-hour, #schedule-dom').on('input', updateSchedulePreview);
    $('#schedule-dow').on('change', updateSchedulePreview);
    updateScheduleFieldsVisibility();
    updateSchedulePreview();
  }

  function updateScheduleFieldsVisibility() {
    var mode = $('#schedule-mode').val();
    var showHour = (mode === 'daily' || mode === 'weekly' || mode === 'monthly');
    var showDow = (mode === 'weekly');
    var showDom = (mode === 'monthly');

    $('#schedule-hour').prop('disabled', !showHour);
    $('#schedule-dow').prop('disabled', !showDow);
    $('#schedule-dom').prop('disabled', !showDom);
  }

  function updateSchedulePreview() {
    var mode = $('#schedule-mode').val();
    var minute = parseInt($('#schedule-minute').val() || '0', 10);
    var hour = parseInt($('#schedule-hour').val() || '0', 10);
    var dow = $('#schedule-dow').val();
    var dom = parseInt($('#schedule-dom').val() || '1', 10);

    var cron = '';
    if (mode === 'hourly') {
      cron = minute + ' * * * *';
    } else if (mode === 'daily') {
      cron = minute + ' ' + hour + ' * * *';
    } else if (mode === 'weekly') {
      cron = minute + ' ' + hour + ' * * ' + dow;
    } else if (mode === 'monthly') {
      cron = minute + ' ' + hour + ' ' + dom + ' * *';
    }

    $('#schedule-preview').text('Cron: ' + cron);
    // Update button tooltip with current cron expression
    $('button[onclick="confirmSaveSchedule()"]').attr('title', 'Cron configuration: ' + cron);
  }

  function confirmSaveSchedule() {
    var mode = $('#schedule-mode').val();
    var minute = parseInt($('#schedule-minute').val() || '0', 10);
    var hour = parseInt($('#schedule-hour').val() || '0', 10);
    var dow = parseInt($('#schedule-dow').val() || '1', 10);
    var dom = parseInt($('#schedule-dom').val() || '1', 10);

    if (isNaN(minute) || minute < 0 || minute > 59) {
      showStatus('Minute must be between 0 and 59', 'error');
      return;
    }
    if ((mode === 'daily' || mode === 'weekly' || mode === 'monthly') && (isNaN(hour) || hour < 0 || hour > 23)) {
      showStatus('Hour must be between 0 and 23', 'error');
      return;
    }
    if (mode === 'weekly' && (isNaN(dow) || dow < 0 || dow > 6)) {
      showStatus('Day of week must be between 0 and 6', 'error');
      return;
    }
    if (mode === 'monthly' && (isNaN(dom) || dom < 1 || dom > 31)) {
      showStatus('Day of month must be between 1 and 31', 'error');
      return;
    }

    // Generate cron expression and human readable text
    var cron = '';
    var humanReadable = '';
    
    if (mode === 'hourly') {
      cron = minute + ' * * * *';
      humanReadable = 'Every hour at minute ' + minute;
    } else if (mode === 'daily') {
      cron = minute + ' ' + hour + ' * * *';
      humanReadable = 'Every day at ' + hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
    } else if (mode === 'weekly') {
      cron = minute + ' ' + hour + ' * * ' + dow;
      var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      humanReadable = 'Every ' + days[dow] + ' at ' + hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
    } else if (mode === 'monthly') {
      cron = minute + ' ' + hour + ' ' + dom + ' * *';
      humanReadable = 'Every month on day ' + dom + ' at ' + hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
    }
    
    var displayText = humanReadable + '<br><small>(Cron configuration: ' + cron + ')</small>';
    
    showModal(
      'Update Schedule',
      'Save the new schedule?<br><br><strong>' + displayText + '</strong><br><br>This controls when automatic scans run.',
      'primary',
      saveSchedule,
      { mode: mode, minute: minute, hour: hour, dow: dow, dom: dom, preview: cron }
    );
  }

  function saveSchedule(payload) {
    $.ajax({
      url: "set-schedule.cgi",
      method: "POST",
      data: {
        mode: payload.mode,
        minute: payload.minute,
        hour: payload.hour,
        dow: payload.dow,
        dom: payload.dom
      },
      success: function(resp) {
        if (resp && resp.success) {
          firework.launch('Schedule updated', 'success', 3000);
          $('#schedule-unsupported').hide();
          $('#schedule-preview').text('Cron: ' + (resp.schedule || payload.preview));
    // Update button tooltip with saved cron expression
    $('button[onclick="confirmSaveSchedule()"]').attr('title', 'Current schedule: ' + (resp.schedule || payload.preview));
        } else {
          firework.launch('Failed to update schedule: ' + (resp && resp.error ? resp.error : 'unknown error'), 'danger', 3000);
        }
      },
      error: function(xhr, status, error) {
        firework.launch('Failed to update schedule: ' + error, 'danger', 3000);
      }
    });
  }

  // Modal Functions
  function showModal(title, message, type, onConfirm, data) {
    pendingAction = onConfirm;
    pendingData = data;
    $('#modal-title').text(title);
    $('#modal-message').html(message);
    $('#modal-header').removeClass('danger primary').addClass(type);
    $('#modal-confirm-btn').removeClass('btn-danger btn-primary').addClass(type === 'danger' ? 'btn-danger' : 'btn-primary');
    $('#modal-overlay').show();
  }

  function closeModal() {
    $('#modal-overlay').hide();
    pendingAction = null;
    pendingData = null;
  }

  function modalConfirm() {
    if (pendingAction) {
      pendingAction(pendingData);
    }
    closeModal();
  }
</script>

</body>
</html>
